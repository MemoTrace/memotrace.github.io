import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as e,o as i}from"./app-CQ4y5OfI.js";const p={};function l(t,s){return i(),a("div",null,s[0]||(s[0]=[e(`<h1 id="一、💡-引言" tabindex="-1"><a class="header-anchor" href="#一、💡-引言"><span>一、💡 引言</span></a></h1><h1 id="二、✨-功能特点" tabindex="-1"><a class="header-anchor" href="#二、✨-功能特点"><span>二、✨ 功能特点</span></a></h1><h1 id="三、⛏️-技术方案" tabindex="-1"><a class="header-anchor" href="#三、⛏️-技术方案"><span>三、⛏️ 技术方案</span></a></h1><h2 id="_3-1-微信聊天记录的存储结构-sqlite数据库" tabindex="-1"><a class="header-anchor" href="#_3-1-微信聊天记录的存储结构-sqlite数据库"><span>3.1 微信聊天记录的存储结构（SQLite数据库）</span></a></h2><h3 id="_3-1-1-微信3" tabindex="-1"><a class="header-anchor" href="#_3-1-1-微信3"><span>3.1.1 微信3</span></a></h3><p>微信3数据库目录结构</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>├─Msg</span></span>
<span class="line"><span>│  │  Applet.db             # 小程序</span></span>
<span class="line"><span>│  │  BizChat.db            # </span></span>
<span class="line"><span>│  │  BizChatMsg.db</span></span>
<span class="line"><span>│  │  ChatMsg.db</span></span>
<span class="line"><span>│  │  ChatRoomUser.db</span></span>
<span class="line"><span>│  │  ClientGeneral.db</span></span>
<span class="line"><span>│  │  CustomerService.db</span></span>
<span class="line"><span>│  │  Emotion.db            # 表情包</span></span>
<span class="line"><span>│  │  Favorite.db           # 微信收藏</span></span>
<span class="line"><span>│  │  FTSContact.db         # 搜索联系人</span></span>
<span class="line"><span>│  │  FTSFavorite.db        # 搜索收藏</span></span>
<span class="line"><span>│  │  FunctionMsg.db</span></span>
<span class="line"><span>│  │  HardLinkFile.db       # 微信文件</span></span>
<span class="line"><span>│  │  HardLinkImage.db      # 微信图片</span></span>
<span class="line"><span>│  │  HardLinkVideo.db      # 微信视频</span></span>
<span class="line"><span>│  │  ImageTranslate.db</span></span>
<span class="line"><span>│  │  LinkHistory.db</span></span>
<span class="line"><span>│  │  MicroMsg.db           # 微信联系人</span></span>
<span class="line"><span>│  │  Misc.db               # 微信联系人头像</span></span>
<span class="line"><span>│  │  MultiSearchChatMsg.db</span></span>
<span class="line"><span>│  │  NewTips.db</span></span>
<span class="line"><span>│  │  OpenIMContact.db      # 企业微信联系人</span></span>
<span class="line"><span>│  │  OpenIMMedia.db        # 企业微信语音</span></span>
<span class="line"><span>│  │  OpenIMMsg.db          # 企业微信聊天记录</span></span>
<span class="line"><span>│  │  OpenIMResource.db     # 企业微信联系人公司信息</span></span>
<span class="line"><span>│  │  PreDownload.db        </span></span>
<span class="line"><span>│  │  PublicMsg.db          # 公众号消息</span></span>
<span class="line"><span>│  │  PublicMsgMedia.db     # 公众号语音消息</span></span>
<span class="line"><span>│  │  Sns.db                # 朋友圈数据</span></span>
<span class="line"><span>│  │  StoreEmotion.db</span></span>
<span class="line"><span>│  │  SyncMsg.db</span></span>
<span class="line"><span>│  │  Voip.db</span></span>
<span class="line"><span>│  │  </span></span>
<span class="line"><span>│  └─Multi                  # Multi文件夹里的数据库采用了分库操作，将一个大数据库分成多个便于提高检索效率</span></span>
<span class="line"><span>│          FTSMSG0.db       # 搜索聊天记录</span></span>
<span class="line"><span>│          FTSMSG1.db</span></span>
<span class="line"><span>│          MediaMSG0.db     # 语音消息 0</span></span>
<span class="line"><span>│          MediaMSG1.db     # 语音消息 1</span></span>
<span class="line"><span>│          MSG0.db          # 聊天记录 0</span></span>
<span class="line"><span>│          MSG1.db          # 聊天记录 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-2-微信4" tabindex="-1"><a class="header-anchor" href="#_3-1-2-微信4"><span>3.1.2 微信4</span></a></h3><p>微信4数据库目录结构</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>├─db_storage</span></span>
<span class="line"><span>│  │  </span></span>
<span class="line"><span>│  ├─biz</span></span>
<span class="line"><span>│  │      biz.db                </span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─contact                    # 联系人</span></span>
<span class="line"><span>│  │      contact.db</span></span>
<span class="line"><span>│  │      contact_fts.db</span></span>
<span class="line"><span>│  │      fmessage_new.db</span></span>
<span class="line"><span>│  │      wa_contact_new.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─emoticon                   # 表情包</span></span>
<span class="line"><span>│  │      emoticon.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─favorite                   # 微信收藏</span></span>
<span class="line"><span>│  │      favorite.db</span></span>
<span class="line"><span>│  │      favorite_fts.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─hardlink                   # 微信图片、视频、文件</span></span>
<span class="line"><span>│  │      hardlink.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─head_image                 # 微信头像</span></span>
<span class="line"><span>│  │      head_image.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─ilinkvoip</span></span>
<span class="line"><span>│  │      ilinkvoip.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─message                    # 聊天记录</span></span>
<span class="line"><span>│  │      biz_message_0.db      # 公众号消息</span></span>
<span class="line"><span>│  │      media_0.db            # 语音消息</span></span>
<span class="line"><span>│  │      message_0.db          # 聊天记录</span></span>
<span class="line"><span>│  │      message_1.db</span></span>
<span class="line"><span>│  │      message_fts.db</span></span>
<span class="line"><span>│  │      message_resource.db</span></span>
<span class="line"><span>│  │      message_revoke.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─newtips</span></span>
<span class="line"><span>│  │      newtips.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─session                    # 聊天会话窗口</span></span>
<span class="line"><span>│  │      session.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─sns                        # 朋友圈</span></span>
<span class="line"><span>│  │      sns.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─teenager</span></span>
<span class="line"><span>│  │      teenager.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─tencentpay</span></span>
<span class="line"><span>│  │      tencentpay.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  ├─wcfinder</span></span>
<span class="line"><span>│  │      wcfinder.db</span></span>
<span class="line"><span>│  │      </span></span>
<span class="line"><span>│  └─websearch</span></span>
<span class="line"><span>│          websearch.db</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-3-数据库结构说明" tabindex="-1"><a class="header-anchor" href="#_3-1-3-数据库结构说明"><span>3.1.3 数据库结构说明</span></a></h3><p>不管是微信3还是微信4，聊天数据、图片、视频、文件、表情包、语音都是存储在不同的数据库中的，因此解析一条聊天记录要综合查询多个数据库的内容。</p><p>为了避免跨数据库连接操作，MemoTrace为每个数据库都建立一个连接，各数据库之间互相不产生依赖，由上层模块综合调用各个数据库，组装出每一条完整的数据。</p><p>微信3和微信4的数据库不尽相同，部分数据库字段有很大调整，所以MemoTrace把v3和v4分成独立的两个部分，把v3和v4的聊天记录(Message)和联系人(Contact)抽象得出相同的一个数据结构，通过ManagerV3和ManagerV4实现不同数据库模块的分布管理和扩展，通过DataBaseInterface层对外提供统一接口，隔离内部实现。</p><p>详细设计将在后面给出。</p><figure><img src="https://blog.lc044.love/static/img/0fbb4eafa332f2a77d912ffa9c72f0bd.image.webp" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h2 id="_3-2-微信部分数据解析" tabindex="-1"><a class="header-anchor" href="#_3-2-微信部分数据解析"><span>3.2 微信部分数据解析</span></a></h2><h3 id="_3-2-1-微信图片说明" tabindex="-1"><a class="header-anchor" href="#_3-2-1-微信图片说明"><span>3.2.1 微信图片说明</span></a></h3><h4 id="微信3" tabindex="-1"><a class="header-anchor" href="#微信3"><span>微信3</span></a></h4><blockquote><p>微信4.0之前的图片都采用了最简单的异或加密，即采用一个异或密钥（一个0-255的整数）与图片文件的每个字节进行异或运算。由于异或运算具有可逆性，采用相同的密钥再做一次异或运算即可得到原始图片文件。</p></blockquote><p><strong>异或运算性质</strong></p><ol><li>交换律： A ^ B = B ^ A</li><li>结合律： ( A ^ B ) ^ C = A ^ ( B ^ C )</li><li>自反性： A ^ B ^ B = A</li></ol><p>假设：</p><ul><li>加密后数据：<code>C</code></li><li>已知的原始文件头（Magic Number）：<code>P</code></li><li>密钥：<code>K</code></li><li>密钥长度：<code>L</code></li><li>第 <code>i</code> 个字节：<code>i</code></li></ul><p>不同格式的图片通常有固定的文件头，例如：</p><ul><li><strong>PNG</strong>: <code>89 50 4E 47 0D 0A 1A 0A</code></li><li><strong>JPG</strong>: <code>FF D8 FF E0</code> 或 <code>FF D8 FF DB</code></li><li><strong>BMP</strong>: <code>42 4D</code></li><li><strong>GIF</strong>: <code>47 49 46 38 39 61</code> 或 <code>47 49 46 38 37 61</code></li></ul><p>根据异或运算的性质：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>⊕</mo><msub><mi>K</mi><mrow><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">C_i = P_i \\oplus K_{i} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">⊕</span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><p>可得：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>K</mi><mrow><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>C</mi><mi>i</mi></msub><mo>⊕</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">K_{i} = C_i \\oplus P_i </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">⊕</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><p>所以，我们可以通过已知的加密数据 <code>C</code> 和已知的文件头 <code>P</code> 计算密钥的前 <code>L</code> 个字节：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>K</mi><mn>0</mn></msub><mo>=</mo><msub><mi>C</mi><mn>0</mn></msub><mo>⊕</mo><msub><mi>P</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">K_0 = C_0 \\oplus P_0 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">⊕</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>K</mi><mn>1</mn></msub><mo>=</mo><msub><mi>C</mi><mn>1</mn></msub><mo>⊕</mo><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">K_1 = C_1 \\oplus P_1 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">⊕</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">... </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.10556em;"></span><span class="strut bottom" style="height:0.10556em;vertical-align:0em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>K</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>C</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>⊕</mo><msub><mi>P</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">K_{L-1} = C_{L-1} \\oplus P_{L-1} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">L</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.07153em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">L</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">⊕</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">L</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><p>密钥是一个0-255范围内的整数所以: key = K_{0} = K_{1} = K_{2} ··· = K_{L-1}</p><h4 id="微信4" tabindex="-1"><a class="header-anchor" href="#微信4"><span>微信4</span></a></h4><blockquote><p>微信4的图片采用AES-EBC和异或混合加密方式。</p></blockquote><p><strong>.dat文件头(15个字节)</strong></p><table><thead><tr><th>大小(字节)</th><th>内容/类型</th><th>说明</th></tr></thead><tbody><tr><td>6</td><td>0x07085631</td><td>.dat文件标识符</td></tr><tr><td>4</td><td>int （小端序）</td><td>AES-EBC128 加密长度</td></tr><tr><td>4</td><td>int （小端序）</td><td>异或加密长度</td></tr><tr><td>1</td><td>0x01</td><td>未知</td></tr></tbody></table><figure><img src="https://blog.lc044.love/static/img/a049d886cbd0e95ca2018ac91843a966.image.webp" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><p><strong>文件末尾采用异或加密，加密长度最大为1MB，多余部分未加密。</strong></p><blockquote><p>例如：一个文件小于1kB，则全部是AES加密，如果大于1kB且小于1MB（实际是1MB零1KB），则前1KB部分采用AES加密，剩余部分采用异或加密。如果文件大于1MB，则前1KB采用AES加密，后面1MB采用异或加密，中间部分未加密。</p></blockquote><figure><img src="https://blog.lc044.love/static/img/403cd0087b1a728b2e73314c414f5a0f.image.webp" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><ul><li>AES 密钥为：<code>0xcfcd208495d565ef</code></li><li>根据异或运算的可逆性，结合jpg文件末尾的 <strong>FF D9</strong> 两个字节，可以找一张微信生成的缩略图（一般为_t.dat结尾），两次异或运算即可得到异或密钥。</li></ul><h3 id="_3-2-2-微信文件、文件夹命名" tabindex="-1"><a class="header-anchor" href="#_3-2-2-微信文件、文件夹命名"><span>3.2.2 微信文件、文件夹命名</span></a></h3><h4 id="微信3-1" tabindex="-1"><a class="header-anchor" href="#微信3-1"><span>微信3</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>├─Applet</span></span>
<span class="line"><span>├─Backup</span></span>
<span class="line"><span>├─FileStorage       # 存储微信图片、视频、文件</span></span>
<span class="line"><span>│  ├─Cache          # 缩略图缓存</span></span>
<span class="line"><span>│  ├─CustomEmotion  # 表情包</span></span>
<span class="line"><span>│  ├─Fav            # 收藏</span></span>
<span class="line"><span>│  ├─File           # 微信文件</span></span>
<span class="line"><span>│  ├─MsgAttach      # 微信里与每个人的聊天数据</span></span>
<span class="line"><span>│  │  └─aefd036248e0d4d0f07900a6239272e4    # 该联系人wxid的md5加密</span></span>
<span class="line"><span>│  │      ├─Image                           # 聊天图片</span></span>
<span class="line"><span>│  │      │  └─2024-10</span></span>
<span class="line"><span>│  │      ├─Thumb                           # 聊天中产生的缩略图</span></span>
<span class="line"><span>│  │      │  └─2024-10</span></span>
<span class="line"><span>│  │      ├─File                            # 合并转发的聊天记录里的文件</span></span>
<span class="line"><span>│  │      │  └─2024-10</span></span>
<span class="line"><span>│  │      └─Video                           # 合并转发的聊天记录里的视频</span></span>
<span class="line"><span>│  │          └─2024-10</span></span>
<span class="line"><span>│  ├─Sns            # 朋友圈数据</span></span>
<span class="line"><span>│  ├─Video          # 聊天视频</span></span>
<span class="line"><span>│  │  └─2025-02</span></span>
<span class="line"><span>│  └─XEditor</span></span>
<span class="line"><span>├─Msg               # 聊天记录数据库</span></span>
<span class="line"><span>└─ResUpdateV2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="微信4-1" tabindex="-1"><a class="header-anchor" href="#微信4-1"><span>微信4</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>├─business</span></span>
<span class="line"><span>├─cache             # 缓存</span></span>
<span class="line"><span>├─config            # 配置文件</span></span>
<span class="line"><span>├─db_storage        # 聊天记录数据库</span></span>
<span class="line"><span>├─msg               # 与好友的聊天数据</span></span>
<span class="line"><span>│  ├─attach         # 微信里与每个人的聊天数据</span></span>
<span class="line"><span>│  │  └─aefd036248e0d4d0f07900a6239272e4    # 该联系人wxid的md5加密</span></span>
<span class="line"><span>│  │  │  ├─2022-01                          # 日期</span></span>
<span class="line"><span>│  │  │  │  ├─Img                           # 聊天图片</span></span>
<span class="line"><span>│  │  │  │  └─Rec                           # 合并转发的聊天记录数据</span></span>
<span class="line"><span>│  │  │  │      └─2090_136022</span></span>
<span class="line"><span>│  │  │  │          └─Img</span></span>
<span class="line"><span>│  ├─file           # 微信文件</span></span>
<span class="line"><span>│  └─video          # 微信视频</span></span>
<span class="line"><span>├─Msg               # 聊天记录数据库</span></span>
<span class="line"><span>└─temp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>微信4的文件命名方式跟之前有些微区别，但其数据存放是类似的（文件、视频单独存放在独立的文件夹中，图片按联系人分组存放到不同的文件夹中）</p><h2 id="_3-3-技术选型-python、sqlite、protobuf解析等" tabindex="-1"><a class="header-anchor" href="#_3-3-技术选型-python、sqlite、protobuf解析等"><span>3.3 技术选型（Python、SQLite、protobuf解析等）</span></a></h2><h2 id="_3-4-主要依赖库" tabindex="-1"><a class="header-anchor" href="#_3-4-主要依赖库"><span>3.4 主要依赖库</span></a></h2><h1 id="四、🔭-系统架构设计" tabindex="-1"><a class="header-anchor" href="#四、🔭-系统架构设计"><span>四、🔭 系统架构设计</span></a></h1><h1 id="五、🔎-详细设计" tabindex="-1"><a class="header-anchor" href="#五、🔎-详细设计"><span>五、🔎 详细设计</span></a></h1>`,55)]))}const r=n(p,[["render",l],["__file","wexin-info.html.vue"]]),m=JSON.parse('{"path":"/posts/develop/wexin/wexin-info.html","title":"一、💡 引言","lang":"zh-CN","frontmatter":{"description":"一、💡 引言 二、✨ 功能特点 三、⛏️ 技术方案 3.1 微信聊天记录的存储结构（SQLite数据库） 3.1.1 微信3 微信3数据库目录结构 3.1.2 微信4 微信4数据库目录结构 3.1.3 数据库结构说明 不管是微信3还是微信4，聊天数据、图片、视频、文件、表情包、语音都是存储在不同的数据库中的，因此解析一条聊天记录要综合查询多个数据库的...","head":[["meta",{"property":"og:url","content":"https://memotrace.cn/doc/posts/develop/wexin/wexin-info.html"}],["meta",{"property":"og:site_name","content":"MemoTrace"}],["meta",{"property":"og:title","content":"一、💡 引言"}],["meta",{"property":"og:description","content":"一、💡 引言 二、✨ 功能特点 三、⛏️ 技术方案 3.1 微信聊天记录的存储结构（SQLite数据库） 3.1.1 微信3 微信3数据库目录结构 3.1.2 微信4 微信4数据库目录结构 3.1.3 数据库结构说明 不管是微信3还是微信4，聊天数据、图片、视频、文件、表情包、语音都是存储在不同的数据库中的，因此解析一条聊天记录要综合查询多个数据库的..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://blog.lc044.love/static/img/0fbb4eafa332f2a77d912ffa9c72f0bd.image.webp"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-04-03T05:56:10.000Z"}],["meta",{"property":"article:author","content":"司小远"}],["meta",{"property":"article:modified_time","content":"2025-04-03T05:56:10.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"一、💡 引言\\",\\"image\\":[\\"https://blog.lc044.love/static/img/0fbb4eafa332f2a77d912ffa9c72f0bd.image.webp\\",\\"https://blog.lc044.love/static/img/a049d886cbd0e95ca2018ac91843a966.image.webp\\",\\"https://blog.lc044.love/static/img/403cd0087b1a728b2e73314c414f5a0f.image.webp\\"],\\"dateModified\\":\\"2025-04-03T05:56:10.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"司小远\\",\\"url\\":\\"https://lc044.love/\\"}]}"]]},"headers":[{"level":2,"title":"3.1 微信聊天记录的存储结构（SQLite数据库）","slug":"_3-1-微信聊天记录的存储结构-sqlite数据库","link":"#_3-1-微信聊天记录的存储结构-sqlite数据库","children":[{"level":3,"title":"3.1.1 微信3","slug":"_3-1-1-微信3","link":"#_3-1-1-微信3","children":[]},{"level":3,"title":"3.1.2 微信4","slug":"_3-1-2-微信4","link":"#_3-1-2-微信4","children":[]},{"level":3,"title":"3.1.3 数据库结构说明","slug":"_3-1-3-数据库结构说明","link":"#_3-1-3-数据库结构说明","children":[]}]},{"level":2,"title":"3.2 微信部分数据解析","slug":"_3-2-微信部分数据解析","link":"#_3-2-微信部分数据解析","children":[{"level":3,"title":"3.2.1 微信图片说明","slug":"_3-2-1-微信图片说明","link":"#_3-2-1-微信图片说明","children":[]},{"level":3,"title":"3.2.2 微信文件、文件夹命名","slug":"_3-2-2-微信文件、文件夹命名","link":"#_3-2-2-微信文件、文件夹命名","children":[]}]},{"level":2,"title":"3.3 技术选型（Python、SQLite、protobuf解析等）","slug":"_3-3-技术选型-python、sqlite、protobuf解析等","link":"#_3-3-技术选型-python、sqlite、protobuf解析等","children":[]},{"level":2,"title":"3.4 主要依赖库","slug":"_3-4-主要依赖库","link":"#_3-4-主要依赖库","children":[]}],"git":{"createdTime":1743659770000,"updatedTime":1743659770000,"contributors":[{"name":"SiYuan","email":"863909694@qq.com","commits":1}]},"readingTime":{"minutes":5.01,"words":1502},"filePathRelative":"posts/develop/wexin/wexin-info.md","localizedDate":"2025年4月3日","autoDesc":true,"excerpt":"\\n<h1>二、✨ 功能特点</h1>\\n<h1>三、⛏️ 技术方案</h1>\\n<h2>3.1 微信聊天记录的存储结构（SQLite数据库）</h2>\\n<h3>3.1.1 微信3</h3>\\n<p>微信3数据库目录结构</p>\\n<div class=\\"language-text line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"text\\" data-title=\\"text\\" style=\\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes github-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>├─Msg</span></span>\\n<span class=\\"line\\"><span>│  │  Applet.db             # 小程序</span></span>\\n<span class=\\"line\\"><span>│  │  BizChat.db            # </span></span>\\n<span class=\\"line\\"><span>│  │  BizChatMsg.db</span></span>\\n<span class=\\"line\\"><span>│  │  ChatMsg.db</span></span>\\n<span class=\\"line\\"><span>│  │  ChatRoomUser.db</span></span>\\n<span class=\\"line\\"><span>│  │  ClientGeneral.db</span></span>\\n<span class=\\"line\\"><span>│  │  CustomerService.db</span></span>\\n<span class=\\"line\\"><span>│  │  Emotion.db            # 表情包</span></span>\\n<span class=\\"line\\"><span>│  │  Favorite.db           # 微信收藏</span></span>\\n<span class=\\"line\\"><span>│  │  FTSContact.db         # 搜索联系人</span></span>\\n<span class=\\"line\\"><span>│  │  FTSFavorite.db        # 搜索收藏</span></span>\\n<span class=\\"line\\"><span>│  │  FunctionMsg.db</span></span>\\n<span class=\\"line\\"><span>│  │  HardLinkFile.db       # 微信文件</span></span>\\n<span class=\\"line\\"><span>│  │  HardLinkImage.db      # 微信图片</span></span>\\n<span class=\\"line\\"><span>│  │  HardLinkVideo.db      # 微信视频</span></span>\\n<span class=\\"line\\"><span>│  │  ImageTranslate.db</span></span>\\n<span class=\\"line\\"><span>│  │  LinkHistory.db</span></span>\\n<span class=\\"line\\"><span>│  │  MicroMsg.db           # 微信联系人</span></span>\\n<span class=\\"line\\"><span>│  │  Misc.db               # 微信联系人头像</span></span>\\n<span class=\\"line\\"><span>│  │  MultiSearchChatMsg.db</span></span>\\n<span class=\\"line\\"><span>│  │  NewTips.db</span></span>\\n<span class=\\"line\\"><span>│  │  OpenIMContact.db      # 企业微信联系人</span></span>\\n<span class=\\"line\\"><span>│  │  OpenIMMedia.db        # 企业微信语音</span></span>\\n<span class=\\"line\\"><span>│  │  OpenIMMsg.db          # 企业微信聊天记录</span></span>\\n<span class=\\"line\\"><span>│  │  OpenIMResource.db     # 企业微信联系人公司信息</span></span>\\n<span class=\\"line\\"><span>│  │  PreDownload.db        </span></span>\\n<span class=\\"line\\"><span>│  │  PublicMsg.db          # 公众号消息</span></span>\\n<span class=\\"line\\"><span>│  │  PublicMsgMedia.db     # 公众号语音消息</span></span>\\n<span class=\\"line\\"><span>│  │  Sns.db                # 朋友圈数据</span></span>\\n<span class=\\"line\\"><span>│  │  StoreEmotion.db</span></span>\\n<span class=\\"line\\"><span>│  │  SyncMsg.db</span></span>\\n<span class=\\"line\\"><span>│  │  Voip.db</span></span>\\n<span class=\\"line\\"><span>│  │  </span></span>\\n<span class=\\"line\\"><span>│  └─Multi                  # Multi文件夹里的数据库采用了分库操作，将一个大数据库分成多个便于提高检索效率</span></span>\\n<span class=\\"line\\"><span>│          FTSMSG0.db       # 搜索聊天记录</span></span>\\n<span class=\\"line\\"><span>│          FTSMSG1.db</span></span>\\n<span class=\\"line\\"><span>│          MediaMSG0.db     # 语音消息 0</span></span>\\n<span class=\\"line\\"><span>│          MediaMSG1.db     # 语音消息 1</span></span>\\n<span class=\\"line\\"><span>│          MSG0.db          # 聊天记录 0</span></span>\\n<span class=\\"line\\"><span>│          MSG1.db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 聊天记录 1</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{r as comp,m as data};
